<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Green Earth â€” Plant a Tree</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- DaisyUI CSS (provides input/button classes) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" />

  <style>
    /* small custom styles */
    .banner-bg {
      background-image:
        linear-gradient(rgba(0,60,20,0.06), rgba(0,60,20,0.02)),
        url('https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1800&auto=format&fit=crop&ixlib=rb-4.0.3&s=6b1bde0f2f93b8f6619b9e8f477a2fbd');
      background-size: cover;
      background-position: center;
    }
    .card-img-placeholder { min-height: 120px; border-radius: 8px; overflow: hidden; }
    .cart-scroll { max-height: 420px; overflow-y: auto; }
    .spinner-center { position: fixed; left: 50%; top: 42%; transform: translate(-50%, -50%); z-index: 60; }
    .loader { border-top-color: #16a34a; animation: spin 1s infinite linear; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .api-error { background: #fff7ed; border: 1px solid #ffedd5; color: #92400e; }
  </style>
</head>
<body class="bg-emerald-50 text-slate-800">

  <!-- HEADER -->
  <header class="bg-emerald-700 text-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-full bg-white/10 flex items-center justify-center font-bold">ðŸŒ±</div>
          <div class="text-lg font-semibold">Green Earth</div>
        </div>

        <nav class="hidden md:flex gap-6 text-sm">
          <a class="hover:underline" href="#">Home</a>
          <a class="hover:underline" href="#about">About</a>
          <a class="hover:underline" href="#impact">Impact</a>
        </nav>

        <div class="hidden md:flex">
          <a id="plant-btn" class="btn btn-warning btn-sm">Plant a Tree</a>
        </div>

        <div class="md:hidden">
          <button id="mobile-toggle" aria-label="menu" class="p-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- BANNER -->
  <section class="banner-bg py-14">
    <div class="max-w-5xl mx-auto px-4 text-center">
      <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900">Plant a Tree, Grow a Future</h1>
      <p class="mt-3 text-slate-700">Join our mission â€” plant 1 million trees and leave a greener world for the next generation.</p>
      <div class="mt-6">
        <button id="banner-action" class="btn btn-success">Get Involved</button>
      </div>
    </div>
  </section>

  <!-- API error banner (hidden by default) -->
  <div id="api-error" class="max-w-6xl mx-auto mt-4 px-4 hidden">
    <div class="p-3 rounded api-error">
      <strong>API connection issue:</strong>
      <span id="api-error-msg">Attempting to connect...</span>
      <div class="text-xs mt-1">If this persists, try running the file from a local server (e.g. `npx http-server .`), or allow CORS in your browser. The app will attempt a proxied fetch automatically.</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 -mt-8">

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- CATEGORIES -->
      <aside class="lg:col-span-3 bg-white rounded-lg p-4 shadow-sm">
        <h3 class="font-semibold mb-3">Categories</h3>
        <div id="categories" class="space-y-2">
          <div class="text-sm text-slate-500">Loading categories...</div>
        </div>
      </aside>

      <!-- CARDS -->
      <section class="lg:col-span-7">
        <div class="bg-white rounded-lg p-6 shadow-sm">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Choose Your Trees</h2>
            <div id="loading-indicator" class="text-sm text-slate-500 hidden">Loading...</div>
          </div>

          <!-- spinner overlay -->
          <div id="global-spinner" class="hidden">
            <div class="spinner-center">
              <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-14 w-14"></div>
            </div>
          </div>

          <div id="cards-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- product cards will appear here -->
          </div>
        </div>

        <!-- ABOUT -->
        <section id="about" class="mt-8 bg-white rounded-lg p-6 shadow-sm">
          <div class="flex flex-col md:flex-row gap-6 items-center">
            <img src="https://images.unsplash.com/photo-1501004318641-b39e6451bec6?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=4d0cae3b262a5f04f3a8f7ccbf6a9e3f" alt="Plant" class="w-full md:w-1/3 rounded-lg object-cover shadow" />
            <div>
              <h3 class="font-semibold text-xl mb-2">About the Campaign</h3>
              <p class="text-slate-600">Green Earth is a global tree-plantation initiative dedicated to fighting climate change and restoring natural habitats. We partner with local communities to plant native trees, create jobs, and educate for long-term stewardship.</p>
              <ul class="mt-3 list-disc list-inside text-slate-600">
                <li>Reforestation of natural habitats</li>
                <li>Partnership with local communities</li>
                <li>Support for local conservation</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- IMPACT -->
        <section id="impact" class="mt-8 bg-white rounded-lg p-6 shadow-sm">
          <h3 class="font-semibold text-xl mb-4 text-center">Our Impact</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="p-4 bg-emerald-50 rounded-lg text-center">
              <div class="text-2xl font-bold">500K+</div>
              <div class="text-sm text-slate-600">Trees Planted</div>
            </div>
            <div class="p-4 bg-emerald-50 rounded-lg text-center">
              <div class="text-2xl font-bold">120+</div>
              <div class="text-sm text-slate-600">Communities Involved</div>
            </div>
            <div class="p-4 bg-emerald-50 rounded-lg text-center">
              <div class="text-2xl font-bold">30+</div>
              <div class="text-sm text-slate-600">Countries Reached</div>
            </div>
          </div>
        </section>
      </section>

      <!-- CART -->
      <aside class="lg:col-span-2 bg-white rounded-lg p-4 shadow-sm">
        <h3 class="font-semibold mb-3">Your Cart</h3>
        <div id="cart-list" class="space-y-3 cart-scroll">
          <div class="text-slate-500">Your cart is empty.</div>
        </div>

        <div class="mt-4 border-t pt-4">
          <div class="flex justify-between text-sm"><span>Subtotal</span><span id="cart-total">$0</span></div>
          <div class="mt-3">
            <button id="checkout-btn" class="btn btn-success w-full">Checkout</button>
          </div>
        </div>
      </aside>

    </div>

    <!-- PLANT A TREE FORM -->
    <section class="mt-8">
      <div class="bg-emerald-700 text-white rounded-lg p-6">
        <div class="max-w-3xl mx-auto">
          <h3 class="text-xl font-bold mb-2">Plant a Tree Today</h3>
          <p class="mb-4 text-emerald-100">Fill the form to support our campaign â€” your donation helps plant real trees.</p>
          <form id="donation-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
            <input name="name" class="input input-bordered col-span-1 sm:col-span-1" placeholder="Your Name" required />
            <input name="email" type="email" class="input input-bordered col-span-1 sm:col-span-1" placeholder="Your Email" required />
            <select name="number" class="input input-bordered col-span-1 sm:col-span-1">
              <option value="1">1 Tree</option>
              <option value="2">2 Trees</option>
              <option value="5">5 Trees</option>
              <option value="10">10 Trees</option>
            </select>
            <button type="submit" class="btn btn-warning col-span-1 sm:col-span-3 mt-2">Donate Now</button>
          </form>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="mt-6 text-center text-sm text-slate-500">
      Â© <span id="year"></span> Green Earth. All rights reserved.
    </footer>

  </main>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-3xl w-full overflow-auto shadow-lg">
      <div class="p-4">
        <div class="flex justify-between items-start">
          <h4 id="modal-title" class="font-bold text-lg"></h4>
          <button id="modal-close" class="text-slate-500">âœ•</button>
        </div>
        <div id="modal-body" class="mt-3"></div>
      </div>
    </div>
  </div>

  <script>
    /* ============================
       Configuration (endpoints)
       ============================ */
    const API_BASE = 'https://openapi.programming-hero.com/api';
    const PLANTS_URL = API_BASE + '/plants';
    const CATEGORIES_URL = API_BASE + '/categories';
    const CATEGORY_URL = (id) => API_BASE + '/category/' + id;
    const PLANT_URL = (id) => API_BASE + '/plant/' + id;

    /* ============================
       DOM references
       ============================ */
    const categoriesEl = document.getElementById('categories');
    const cardsGrid = document.getElementById('cards-grid');
    const cartList = document.getElementById('cart-list');
    const cartTotalEl = document.getElementById('cart-total');
    const globalSpinner = document.getElementById('global-spinner');
    const apiErrorBanner = document.getElementById('api-error');
    const apiErrorMsg = document.getElementById('api-error-msg');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalClose = document.getElementById('modal-close');

    /* ============================
       State
       ============================ */
    let categories = [];
    let activeCategoryId = null; // null = all
    let plantsCache = {};
    let cart = []; // {id, name, price, qty}

    /* ============================
       Utilities: fetching with timeout + CORS-proxy fallback
       ============================ */

    function fetchWithTimeout(resource, options = {}, timeout = 12000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      const finalOpts = { ...options, signal: controller.signal, headers: { Accept: 'application/json', ...(options.headers || {}) } };
      return fetch(resource, finalOpts).finally(() => clearTimeout(id));
    }

    async function fetchJsonAuto(url, options = {}) {
      // Try direct fetch first
      try {
        const res = await fetchWithTimeout(url, options, 12000);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json') || ct.includes('text/json')) {
          return await res.json();
        } else {
          // try parse text as JSON (some servers return JSON but wrong content-type)
          const text = await res.text();
          return JSON.parse(text);
        }
      } catch (errDirect) {
        // If direct fetch failed (could be CORS or network), try public CORS proxy
        console.warn('Direct fetch failed, trying proxy', errDirect);
        showApiError(true, 'Direct API fetch failed. Attempting proxied fetch...');
        try {
          const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
          const pr = await fetchWithTimeout(proxy, options, 12000);
          if (!pr.ok) throw new Error('Proxy HTTP ' + pr.status);
          const text = await pr.text();
          try {
            return JSON.parse(text);
          } catch (parseErr) {
            // if not JSON, forward raw text
            return text;
          }
        } catch (errProxy) {
          console.error('Proxy fetch failed too', errProxy);
          throw errProxy;
        }
      }
    }

    function showSpinner(show = true) {
      globalSpinner.classList.toggle('hidden', !show);
      document.getElementById('loading-indicator').classList.toggle('hidden', !show);
    }

    function showApiError(show = true, message = '') {
      apiErrorBanner.classList.toggle('hidden', !show);
      apiErrorMsg.textContent = message;
    }

    function setYear() {
      document.getElementById('year').textContent = new Date().getFullYear();
    }

    /* ============================
       Parsing helpers: handle different API shapes
       ============================ */

    function extractArray(resp) {
      if (!resp) return [];
      if (Array.isArray(resp)) return resp;
      if (Array.isArray(resp.data)) return resp.data;
      // nested arrays
      if (resp.data && typeof resp.data === 'object') {
        for (const k of Object.keys(resp.data)) {
          if (Array.isArray(resp.data[k])) return resp.data[k];
        }
      }
      // some APIs return arrays under named keys
      for (const k of ['plants', 'categories', 'items', 'dataList']) {
        if (Array.isArray(resp[k])) return resp[k];
        if (resp.data && Array.isArray(resp.data[k])) return resp.data[k];
      }
      // top-level arrays under some key
      for (const k of Object.keys(resp)) {
        if (Array.isArray(resp[k])) return resp[k];
      }
      // fallback: try to convert object values to array
      if (resp.data && typeof resp.data === 'object') {
        const vals = Object.values(resp.data).filter(v => typeof v === 'object' && !Array.isArray(v));
        if (vals.length) return vals;
      }
      return [];
    }

    function extractObject(resp) {
      if (!resp) return null;
      if (resp.data && typeof resp.data === 'object' && !Array.isArray(resp.data)) return resp.data;
      if (typeof resp === 'object' && !Array.isArray(resp)) return resp;
      return null;
    }

    function normalizeCategory(raw) {
      if (!raw) return null;
      return {
        id: raw.id ?? raw.category_id ?? raw._id ?? raw.cat_id ?? raw.sid ?? (typeof raw === 'string' ? raw : undefined),
        name: raw.name ?? raw.category_name ?? raw.title ?? raw.cat_name ?? raw.label ?? (typeof raw === 'string' ? raw : 'Unnamed Category'),
      };
    }

    function normalizePlant(raw) {
      if (!raw) return null;
      const price = Number(raw.price ?? raw.price_in_usd ?? raw.cost ?? raw.fee ?? 0) || 0;
      return {
        id: raw.id ?? raw.plant_id ?? raw._id ?? raw.sid ?? raw.ID,
        name: raw.name ?? raw.common_name ?? raw.plant_name ?? raw.title ?? 'Unnamed Plant',
        price,
        image: raw.image ?? raw.img ?? raw.image_url ?? raw.photo ?? null,
        description: raw.about ?? raw.description ?? raw.short_description ?? raw.bio ?? '',
        category: raw.category ?? raw.category_name ?? raw.family ?? '',
        raw
      };
    }

    /* ============================
       Rendering functions
       ============================ */

    function renderCategories() {
      categoriesEl.innerHTML = '';
      const list = categories.map(normalizeCategory).filter(Boolean);

      // "All" button
      const allBtn = document.createElement('button');
      allBtn.className = `w-full text-left px-3 py-2 rounded ${activeCategoryId === null ? 'bg-emerald-700 text-white' : 'hover:bg-emerald-50'}`;
      allBtn.textContent = 'All Trees';
      allBtn.addEventListener('click', () => {
        setActiveCategory(null);
        loadPlants(null);
      });
      categoriesEl.appendChild(allBtn);

      list.forEach(c => {
        const btn = document.createElement('button');
        const isActive = String(c.id) === String(activeCategoryId);
        btn.className = `w-full text-left px-3 py-2 rounded ${isActive ? 'bg-emerald-700 text-white' : 'hover:bg-emerald-50'}`;
        btn.textContent = c.name;
        btn.addEventListener('click', () => {
          setActiveCategory(c.id);
          loadPlants(c.id);
        });
        categoriesEl.appendChild(btn);
      });
    }

    function setActiveCategory(id) {
      activeCategoryId = id;
      // small visual update - re-render categories
      renderCategories();
    }

    function renderPlants(plantsRaw) {
      cardsGrid.innerHTML = '';
      showSpinner(false);

      const arr = extractArray(plantsRaw);
      const plants = arr.map(normalizePlant).filter(Boolean);

      if (plants.length === 0) {
        cardsGrid.innerHTML = `<div class="text-slate-500">No plants found for this category.</div>`;
        return;
      }

      plants.forEach(p => {
        const card = document.createElement('div');
        card.className = 'bg-emerald-50 rounded-lg p-4 shadow-sm flex flex-col';

        const imgUrl = p.image || 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=e6f60d87f4b9c1b03c3f0f7296e0f5d9';

        card.innerHTML = `
          <div class="card-img-placeholder mb-3 overflow-hidden rounded">
            <img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(p.name)}" class="w-full h-36 object-cover">
          </div>
          <div class="flex-1">
            <h4 class="font-semibold text-slate-800 cursor-pointer break-words" data-id="${escapeHtml(p.id)}" title="View details">${escapeHtml(p.name)}</h4>
            <p class="text-sm text-slate-600 mt-1">${escapeHtml((p.description || '').slice(0, 120))}${p.description && p.description.length > 120 ? '...' : ''}</p>
          </div>
          <div class="mt-4 flex items-center justify-between">
            <div class="text-sm font-semibold">${formatCurrency(p.price)}</div>
            <button class="btn btn-sm btn-success add-to-cart" data-id="${escapeHtml(p.id)}" data-name="${escapeHtml(p.name)}" data-price="${Number(p.price)}">Add to Cart</button>
          </div>
        `;

        // name click opens details modal (fetch full details from PLANT_URL when needed)
        card.querySelector('h4').addEventListener('click', async (ev) => {
          const id = ev.target.dataset.id;
          await openPlantModal(id, p.raw);
        });

        // add to cart
        card.querySelector('.add-to-cart').addEventListener('click', (ev) => {
          const id = ev.target.dataset.id;
          const name = ev.target.dataset.name;
          const price = Number(ev.target.dataset.price || 0);
          addToCart({ id, name, price });
        });

        cardsGrid.appendChild(card);
      });
    }

    /* ============================
       Modal (plant details)
       ============================ */
    async function openPlantModal(id, rawCandidate = null) {
      showSpinner(true);
      showApiError(false);
      try {
        let details = null;

        // if we have a rawCandidate that already contains a lot of details, use it
        if (rawCandidate && (rawCandidate.description || rawCandidate.about || rawCandidate.bio)) {
          details = rawCandidate;
        } else {
          // try fetching detailed plant endpoint
          try {
            const resp = await fetchJsonAuto(PLANT_URL(id));
            details = extractObject(resp) ?? resp;
          } catch (err) {
            console.warn('Failed to fetch plant details from detail endpoint; falling back to provided raw.', err);
            details = rawCandidate;
          }
        }

        if (!details) {
          modalTitle.textContent = 'Plant Details';
          modalBody.innerHTML = `<div class="text-slate-500">No additional details found for this plant.</div>`;
        } else {
          const n = normalizePlant(details);
          modalTitle.textContent = n.name;
          modalBody.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-1">
                <img src="${escapeHtml(n.image || '')}" alt="${escapeHtml(n.name)}" class="w-full rounded object-cover" />
              </div>
              <div class="md:col-span-2">
                <p class="text-slate-700 mb-2">${escapeHtml(n.description || 'No extended description available.')}</p>
                <div class="text-sm text-slate-600 mb-2"><strong>Category:</strong> ${escapeHtml(n.category || '')}</div>
                <div class="text-sm text-slate-600 mb-2"><strong>Price:</strong> ${formatCurrency(n.price)}</div>
                <button class="btn btn-success" id="modal-add">Add to Cart</button>
              </div>
            </div>
          `;
          modalBody.querySelector('#modal-add').addEventListener('click', () => {
            addToCart({ id: n.id, name: n.name, price: n.price });
            closeModal();
          });
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      } catch (err) {
        console.error('Error opening modal', err);
        showApiError(true, 'Failed to load plant details: ' + (err.message || String(err)));
      } finally {
        showSpinner(false);
      }
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modalTitle.textContent = '';
      modalBody.innerHTML = '';
    }
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (ev) => { if (ev.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    /* ============================
       Cart
       ============================ */
    function addToCart(item) {
      const existing = cart.find(ci => String(ci.id) === String(item.id));
      if (existing) existing.qty += 1;
      else cart.push({ ...item, qty: 1 });
      renderCart();
    }

    function removeFromCart(id) {
      cart = cart.filter(ci => String(ci.id) !== String(id));
      renderCart();
    }

    function changeQty(id, qty) {
      const it = cart.find(c => String(c.id) === String(id));
      if (it) { it.qty = Math.max(1, Number(qty) || 1); renderCart(); }
    }

    function renderCart() {
      cartList.innerHTML = '';
      if (cart.length === 0) {
        cartList.innerHTML = '<div class="text-slate-500">Your cart is empty.</div>';
        cartTotalEl.textContent = formatCurrency(0);
        return;
      }
      cart.forEach(ci => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between gap-3';
        row.innerHTML = `
          <div class="flex-1">
            <div class="font-semibold text-sm">${escapeHtml(ci.name)}</div>
            <div class="text-xs text-slate-500">${formatCurrency(ci.price)} x ${ci.qty} = ${formatCurrency(ci.price * ci.qty)}</div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <div><input type="number" min="1" value="${ci.qty}" data-id="${escapeHtml(ci.id)}" class="input input-sm w-16" /></div>
            <button class="text-red-500 text-sm remove-item" data-id="${escapeHtml(ci.id)}">Remove</button>
          </div>
        `;
        row.querySelector('input').addEventListener('change', (ev) => {
          const q = Number(ev.target.value || 1);
          changeQty(ev.target.dataset.id, q);
        });
        row.querySelector('.remove-item').addEventListener('click', () => removeFromCart(ci.id));
        cartList.appendChild(row);
      });
      const total = cart.reduce((s, it) => s + (Number(it.price) * Number(it.qty)), 0);
      cartTotalEl.textContent = formatCurrency(total);
    }

    document.getElementById('checkout-btn').addEventListener('click', () => {
      const total = cart.reduce((s, it) => s + (Number(it.price) * Number(it.qty)), 0);
      if (cart.length === 0) { alert('Your cart is empty.'); return; }
      alert(`Demo: processed payment of ${formatCurrency(total)}. Thank you!`);
      cart = []; renderCart();
    });

    document.getElementById('donation-form').addEventListener('submit', (ev) => {
      ev.preventDefault();
      const { name, email, number } = ev.target;
      if (!name.value || !email.value) { alert('Please fill name and email.'); return; }
      alert(`Thanks ${name.value}! You donated ${number.value} tree(s).`);
      ev.target.reset();
    });

    /* ============================
       Helpers
       ============================ */
    function formatCurrency(n) {
      const num = Number(n || 0);
      return '$' + num.toLocaleString();
    }
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    /* ============================
       Main: load categories & plants
       ============================ */

    async function loadCategories() {
      categoriesEl.innerHTML = '<div class="text-sm text-slate-500">Loading categories...</div>';
      showApiError(false);
      try {
        const resp = await fetchJsonAuto(CATEGORIES_URL);
        let arr = extractArray(resp);
        // If categories array items are nested objects (e.g. {id, name}) use them, otherwise they might be strings
        categories = arr.map(normalizeCategory).filter(Boolean);
        if (categories.length === 0) {
          // fallback: if response had object with categories keyed, try to convert
          console.warn('No categories extracted, trying object values fallback');
          const o = extractObject(resp);
          if (o) categories = Object.values(o).map(normalizeCategory).filter(Boolean);
        }
        if (categories.length === 0) {
          showApiError(true, 'No categories found in API response. Check API format.');
          categoriesEl.innerHTML = '<div class="text-sm text-red-500">No categories available.</div>';
          return;
        }
        renderCategories();
      } catch (err) {
        console.error('Failed to load categories', err);
        showApiError(true, 'Failed to load categories from API. Error: ' + (err.message || String(err)));
        categoriesEl.innerHTML = '<div class="text-sm text-red-500">Failed to load categories.</div>';
      }
    }

    async function loadPlants(categoryId = null) {
      showSpinner(true);
      cardsGrid.innerHTML = '';
      showApiError(false);
      try {
        const url = categoryId ? CATEGORY_URL(categoryId) : PLANTS_URL;
        const resp = await fetchJsonAuto(url);
        // store raw
        plantsCache[categoryId ?? 'all'] = resp;
        renderPlants(resp);
      } catch (err) {
        console.error('Failed to load plants', err);
        showApiError(true, 'Failed to load plants. Attempted proxied fetch if needed. Error: ' + (err.message || String(err)));
        cardsGrid.innerHTML = '<div class="text-sm text-red-500">Failed to load plants due to API issues.</div>';
      } finally {
        showSpinner(false);
      }
    }

    /* ============================
       Init
       ============================ */
    (function init() {
      setYear();
      loadCategories().then(() => loadPlants(null));
      renderCart();
    })();

  </script>
</body>
</html>
